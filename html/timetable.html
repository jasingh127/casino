<!DOCTYPE html>
<meta charset="utf-8">
<head>

    <link rel="stylesheet" href="../css/third_party/plottable.css">
    <link rel="stylesheet" href="../css/third_party/bootstrap.min.css">
    <link rel="stylesheet" href="../css/third_party/bootstrap-theme.min.css">
    <link rel="stylesheet" href="../css/third_party/jquery.dataTables-1.10.0.css">
    <link rel="stylesheet" href="../css/third_party/scroller.dataTables.min.css">
    <link rel="stylesheet" href="../css/third_party/jquery-ui.css">

    <script type="text/javascript" src="../js/third_party/jquery-2.2.0.min.js"></script>
    <script type="text/javascript" src="../js/third_party/bootstrap.min.js"></script>
    <script type="text/javascript" src="../js/third_party/d3.v3.min.js"></script>
    <script type="text/javascript" src="../js/third_party/d3.tip.v0.6.3.js"></script>
    <script type="text/javascript" src="../js/third_party/jquery.dataTables-1.10.0.js"></script>
    <script type="text/javascript" src="../js/third_party/dataTables.scroller.min.js"></script>
    <script type="text/javascript" src="../js/third_party/plottable.js"></script>
    <script type="text/javascript" src="../js/third_party/d3-jetpack.js"></script>
    <script type="text/javascript" src="../js/third_party/gunzip.min.js"></script>
    <script type="text/javascript" src="../js/third_party/underscore-min.js"></script>
    <script type="text/javascript" src="../js/third_party/jquery-ui.js"></script>

    <script type="text/javascript" src="../js/miscutil.js"></script>
    <script type="text/javascript" src="../js/dbutil.js"></script>
    <script type="text/javascript" src="../js/plottableutil.js"></script>

    <script>
    // Shared persistent variables 
    var timetable_data = { 
      occupancy_chart: null,
      occupancy_raw_data: null,
      occupancy_chart_dataset: null,
      occupancy_chart_xScale: null,
      game_chart: null,
      game_raw_data: null,
      picked_game: -1,
      game_colorScale: ["gray", "aqua", "lime", "maroon", "purple", "red", "blue", "green", "yellow", "olive"]
    };
    </script>
    
    <script>
      $( function() { 
        $("#datepicker").datepicker({
            dateFormat: "mm/dd/yy",
            showOtherMonths: true,
            selectOtherMonths: true,
            autoclose: true,
            changeMonth: true,
            changeYear: true,
            beforeShow: function (input, inst) {
              setTimeout(function () {
                var offsets = $("#datepicker").offset();
                var h = $("#datepicker").outerHeight();
                inst.dpDiv.css({
                  top: offsets.top + h,
                  left: offsets.left
                });
              },0);
            },
            onSelect: function(dateText) {
              var date = $(this).datepicker('getDate');
              var year = date.getFullYear();
              var month = date.getMonth();
              var day = date.getDate();
              var occupancy_refresh_callback = function (data) {
                timetable_data.occupancy_raw_data = data;
                PlottableUtil.refreshOccupancyChart(timetable_data);
                timetable_data.occupancy_chart.renderTo("#occupancy");
              };
              DbUtil.fetchOccupancy({"year":year, "month": month, "day":day}, occupancy_refresh_callback);
            }      
        });      
      });
    </script>

</head>

<body>
  <h1> Current Games </h1>
  <br>
  <br>
  <br>
  <svg id="occupancy" width=150% height="600"></svg>
  <br>
  <br>
  <svg id="game_list" width=50% height="60"></svg>
  <br>
  <br>
  <p> Date: <input type="text" id="datepicker"></p>
  <script>
    var today = new Date();
    var year = today.getFullYear();
    var month = today.getMonth();
    var day = today.getDate();
    
    // Document ready function below
    $(function() {

      // Automatically refresh the page if no user activity happens for N_REFRESH_SECS seconds
      var N_REFRESH_SECS = 120;
      var last_refresh_time = new Date().getTime();
      $(document.body).bind("mousemove keypress", function(e) {
        last_refresh_time = new Date().getTime();
      });

      function refresh() {
        if(new Date().getTime() - last_refresh_time >= N_REFRESH_SECS*1000) 
          window.location.reload(true);
        else 
          setTimeout(refresh, 20000);
      }
      setTimeout(refresh, 20000);

      // Change the calender input-box to today's date
      $("#datepicker").val(today.toLocaleDateString()); 

      // Fetch occupancy data for today from the database and show
      var occupancy_callback = function (data) {
        timetable_data.occupancy_raw_data = data;
        PlottableUtil.OccupancyChart(timetable_data);
        timetable_data.occupancy_chart.renderTo("#occupancy");
      };
      DbUtil.fetchOccupancy({"year":year, "month": month, "day":day}, occupancy_callback);

      // Also, show the game picker table
      var game_callback = function(data) {
        timetable_data.game_raw_data = data;
        PlottableUtil.GameChart(timetable_data);
        timetable_data.game_chart.renderTo("#game_list");
      };
      DbUtil.fetchGames(game_callback);

    });
  </script>
</body>
